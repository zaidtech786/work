<div class="ticket-management p-4 mt-5">
  <!-- Status Cards -->
  <div class="status-cards">
    <div class="card processing">
      <div class="icon"></div>
      <div class="text">
        <div class="title">Processing</div>
        <div class="count">{{ (counts$ | async)?.Processing }}</div>
      </div>
    </div>
    <div class="card raised">
      <div class="icon"></div>
      <div class="text">
        <div class="title">Raised</div>
        <div class="count">{{ (counts$ | async)?.Raised }}</div>
      </div>
    </div>
    <div class="card resolved">
      <div class="icon"></div>
      <div class="text">
        <div class="title">Resolved</div>
        <div class="count">{{ (counts$ | async)?.Resolved }}</div>
      </div>
    </div>
    <div class="card rejected">
      <div class="icon"></div>
      <div class="text">
        <div class="title">Rejected</div>
        <div class="count">{{ (counts$ | async)?.Rejected }}</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div nz-row [nzGutter]="16" class="filters mb-3">
    <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4">
      <label class="form-label mb-1">Filter By</label>
      <nz-select class="w-100" [(ngModel)]="filterBy" [nzAllowClear]="false">
        <nz-option [nzValue]="'all'" nzLabel="All"></nz-option>
        <nz-option [nzValue]="'status'" nzLabel="Status"></nz-option>
        <nz-option [nzValue]="'refId'" nzLabel="Ref ID"></nz-option>
      </nz-select>
    </div>

    <!-- Status / Ref ID conditional -->
    <ng-container *ngIf="filterBy === 'status' || filterBy === 'refId'">
      <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="6" [nzLg]="4">

        <ng-container *ngIf="filterBy === 'status'">
          <label class="form-label mb-1">Status</label>
          <nz-select class="w-100" [(ngModel)]="filters.status">
            <nz-option nzValue="Processing" nzLabel="Processing"></nz-option>
            <nz-option nzValue="Raised" nzLabel="Raised"></nz-option>
            <nz-option nzValue="Resolved" nzLabel="Resolved"></nz-option>
            <nz-option nzValue="Rejected" nzLabel="Rejected"></nz-option>
          </nz-select>
        </ng-container>

        <ng-container *ngIf="filterBy === 'refId'">
          <label class="form-label mb-1">Ref ID</label>
          <input nz-input [(ngModel)]="filters.ticketRefId" placeholder="Enter Ref ID" />
        </ng-container>

      </div>
    </ng-container>


    <!-- Date Range -->
    <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="8">
      <label class="form-label mb-1">Selected Date Range</label>
      <nz-range-picker [(ngModel)]="filters.dateRange" [nzFormat]="'dd/MM/yyyy'" [nzAllowClear]="true"
        [nzPopupStyle]="{ zIndex: 1050, position: 'absolute' }" nzDropdownClassName="custom-range-popup">
      </nz-range-picker>
    </div>


    <!-- Buttons -->
    <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="4">
      <label class="form-label mb-1 d-block">&nbsp;</label>
      <div class="d-flex flex-column flex-sm-row gap-2">
        <button nz-button nzType="primary" class="search-btn" (click)="applyFilter()">
          <i nz-icon nzType="search"></i> Search
        </button>
        <button nz-button nzType="default" (click)="resetFilters()">
          <i nz-icon nzType="reload"></i> Refresh
        </button>
      </div>
    </div>

  </div>

  <!-- Table -->
  <div class="table-responsive">
    <nz-table [nzBordered]="true" [nzSize]="'middle'" [nzData]="tickets" [nzFrontPagination]="true"
      [nzPageIndex]="pageIndex" [nzPageSize]="pageSize" (nzPageIndexChange)="onPageIndexChange($event)"
      (nzPageSizeChange)="onPageSizeChange($event)" [nzShowPagination]="true" [nzShowSizeChanger]="false" class="mt-3">
      <thead class="custom-header">
        <tr>
          <th nzWidth="60px">Sr.No</th>
          <th>Ticket Ref ID</th>
          <th>Category</th>
          <th>Sub Category</th>
          <th>Description</th>
          <th>Created Date</th>
          <th>Updated Date</th>
          <th>Status</th>
          <th>Remark</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ticket of tickets | slice:(pageIndex-1)*pageSize:(pageIndex*pageSize); let i = index">
          <td class="text-center">{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
          <td class="text-center">{{ ticket.ticketRefId }}</td>
          <td class="text-center">{{ ticket.category }}</td>
          <td class="text-center">{{ ticket.subCategory }}</td>
          <td class="text-center">{{ ticket.description }}</td>
          <td class="text-center">{{ ticket.createdAt | date:'dd-MM-yyyy' }}</td>
          <td class="text-center">{{ ticket.updatedAt ? (ticket.updatedAt | date:'dd-MM-yyyy') : '-' }}</td>
          <td class="text-center">
            <nz-tag [nzColor]="
              ticket.status === 'Processing' ? 'warning' :
              ticket.status === 'Raised' ? 'geekblue' :
              ticket.status === 'Resolved' ? 'success' :
              'error'">
              {{ ticket.status }}
            </nz-tag>
          </td>
          <td class="text-center">{{ ticket.remark }}</td>
          <td class="text-center">
            <button nz-button nzType="link" (click)="openDrawer(ticket)">Take Action</button>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>

  <!-- Drawer -->
  <nz-drawer [nzVisible]="isDrawerVisible" nzTitle="Take Action" nzPlacement="right" [nzClosable]="true"
    (nzOnClose)="closeDrawer()" [nzWidth]="drawerWidth">
    <ng-container *nzDrawerContent>
      <!-- Ticket Form -->
      <form [formGroup]="ticketForm" (ngSubmit)="saveTicket()">
        <div class="row g-3 form-gap">
          <div class="col-md-6">
            <label class="form-label">Ticket Ref Id</label>
            <input type="text" class="form-control" formControlName="ticketRefId" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">Category</label>
            <input type="text" class="form-control" formControlName="category" readonly />
          </div>
        </div>
        <div class="row g-3 form-gap">
          <div class="col-md-6">
            <label class="form-label">Sub Category</label>
            <input type="text" class="form-control" formControlName="subCategory" readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <select class="form-select" formControlName="status">
              <option value="Raised">Raised</option>
              <option value="Processing">Processing</option>
              <option value="Resolved">Resolved</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="form-group form-gap">
          <label class="form-label">Description</label>
          <textarea class="form-control" formControlName="description" rows="3" readonly></textarea>
        </div>
        <div class="form-group form-gap">
          <label class="form-label">Remark</label>
          <textarea class="form-control" formControlName="remark" rows="3" placeholder="Enter remark"></textarea>
        </div>
        <div class="mt-4 text-end">
          <button nz-button nzType="primary" htmlType="submit">Submit</button>
          <button nz-button nzType="default" (click)="closeDrawer()">Cancel</button>
        </div>
      </form>

      <!-- Ticket History -->
      <div class="ticket-history mt-5">
        <h5>Update History</h5>
        <nz-table [nzBordered]="true" [nzData]="ticketHistory" [nzShowPagination]="false">
          <ng-template #emptyTemplate></ng-template>
          <thead>
            <tr>
              <th>Updated By</th>
              <th>Status</th>
              <th>Updated At</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let history of ticketHistory">
              <td>{{ history.updatedBy }}</td>
              <td>{{ history.status }}</td>
              <td>{{ history.updatedAt | date:'dd-MM-yyyy hh:mm:ss a' }}</td>
            </tr>
          </tbody>
        </nz-table>
      </div>
    </ng-container>
  </nz-drawer>
</div>